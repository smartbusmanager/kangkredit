<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KangKredit v4.4 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input::placeholder, textarea::placeholder { font-size: 11px; opacity: 0.7; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        body { font-family: 'Inter', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

<div id="login-page" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900 bg-opacity-95 backdrop-blur-md">
    <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md text-center border border-white/20">
        <div class="bg-blue-600 w-20 h-20 rounded-xl text-white font-black text-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200 italic">KK</div>
        <h2 class="text-2xl font-black text-slate-800 uppercase italic">KangKredit Pro</h2>
        <p class="text-slate-600 text-sm mb-5 italic">Aplikasi Sales Management System</p>
        <div class="space-y-4">
            <input type="password" id="pass-input" onkeypress="if(event.key === 'Enter') checkLogin()" class="w-full p-4 bg-slate-50 border-2 rounded-lg text-center font-black tracking-widest outline-none focus:border-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button onclick="checkLogin()" class="w-full bg-blue-600 text-white py-4 rounded-lg font-black uppercase text-xs tracking-widest">Masuk ke Sistem</button>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto p-4 md:p-8">
    <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-2xl shadow-sm border gap-3">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-xl text-white font-black text-lg italic shadow-lg shadow-blue-200">KK</div>
            <div>
                <h1 class="text-lg font-black leading-none">KangKredit <span class="text-blue-600 italic text-xs">v4.4 Pro</span></h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Sales Management System</p>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                <button onclick="showTab('transaksi')" class="px-3 py-1.5 bg-slate-800 text-white rounded-lg font-bold text-xs">üìù Transaksi</button>
                <button onclick="showTab('piutang')" class="px-3 py-1.5 bg-white text-slate-800 border rounded-lg font-bold text-xs">üìâ Piutang & WA</button>
            </div>
            <button onclick="exportData()" class="px-3 py-1.5 text-slate-500 hover:text-blue-600 text-[10px] font-black uppercase">Backup</button>
            <button onclick="document.getElementById('importFile').click()" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-black uppercase tracking-widest">Restore</button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
            <div id="connection-status" class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-slate-50 border">
                <div id="dot-status" class="w-2 h-2 rounded-full bg-slate-400"></div>
                <span id="text-status" class="text-[9px] font-black uppercase tracking-tighter text-slate-500">Sync</span>
            </div>
            <button onclick="logout()" class="px-3 py-1.5 bg-rose-50 text-rose-600 rounded-lg text-[10px] font-black uppercase">üö™ Keluar</button>
        </div>
    </header>

    <div class="mb-8">
        <div class="flex flex-col md:flex-row items-end gap-4 mb-4">
            <div class="flex-1 bg-white p-4 rounded-3xl shadow-sm border flex flex-wrap items-end gap-4">
                <div class="flex-1 min-w-[120px]">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block">Dari</label>
                    <input type="date" id="cfTanggalMulai" onchange="updateCashFlow()" class="w-full p-2 text-xs border rounded-xl bg-slate-50 outline-none">
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block">Sampai</label>
                    <input type="date" id="cfTanggalSelesai" onchange="updateCashFlow()" class="w-full p-2 text-xs border rounded-xl bg-slate-50 outline-none">
                </div>
                <div class="flex-[1.5] min-w-[150px]">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block">Wilayah</label>
                    <input type="text" id="cfFilterAlamat" onkeyup="updateCashFlow()" class="w-full p-2 text-xs border rounded-xl bg-slate-50 outline-none" placeholder="Cari Desa/Kec...">
                </div>
                <button onclick="resetCFFilter()" class="px-4 py-2 bg-slate-100 text-slate-500 text-[10px] font-black rounded-xl uppercase tracking-widest">Reset</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="bg-blue-600 p-4 rounded-2xl shadow-lg text-white"><p class="text-[9px] font-bold uppercase opacity-80 mb-1 leading-none">Omset</p><h2 id="statOmset" class="text-lg font-black tracking-tighter">Rp 0</h2></div>
            <div class="bg-emerald-500 p-4 rounded-2xl shadow-lg text-white"><p class="text-[9px] font-bold uppercase opacity-80 mb-1 leading-none">Cash In</p><h2 id="statCashIn" class="text-lg font-black tracking-tighter">Rp 0</h2></div>
            <div class="bg-rose-500 p-4 rounded-2xl shadow-lg text-white"><p class="text-[9px] font-bold uppercase opacity-80 mb-1 leading-none">Piutang</p><h2 id="statPiutang" class="text-lg font-black tracking-tighter">Rp 0</h2></div>
        </div>
    </div>

    <div id="transaksi" class="tab-content active">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4">
                <div class="bg-white rounded-xl shadow-xl border overflow-hidden sticky top-4">
                    <div class="bg-slate-800 p-3 text-white font-black uppercase text-xs italic tracking-widest text-center">Input Penjualan Baru</div>
                    <div class="p-6 space-y-3">
                        <input type="text" id="pembeli" class="w-full p-3 bg-slate-50 border rounded-md text-sm outline-none" placeholder="Nama Pelanggan">
                        <textarea id="alamat" class="w-full p-3 bg-slate-50 border rounded-md h-16 text-sm resize-none outline-none" placeholder="Alamat Lengkap"></textarea>
                        <input type="text" id="no_hp" class="w-full p-3 bg-slate-50 border rounded-md text-sm outline-none" placeholder="WhatsApp (08xx)">
                        <input type="text" id="barang" class="w-full p-3 bg-slate-50 border rounded-md text-sm outline-none" placeholder="Barang Utama">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="harga" class="w-full p-3 bg-slate-50 border rounded-md font-bold text-sm" placeholder="Harga Rp">
                            <select id="metode" onchange="updateLabelBayar()" class="w-full p-3 bg-slate-50 border rounded-md font-bold text-blue-600 text-xs cursor-pointer">
                                <option value="Cash">üíµ CASH</option>
                                <option value="Kredit">üìâ KREDIT</option>
                            </select>
                        </div>
                        <div id="containerBayar" style="display: none;" class="pt-2"><input type="number" id="bayarAwal" class="w-full p-4 bg-orange-50 border rounded-md font-black text-orange-700 text-center" placeholder="Uang Muka (DP) Rp"></div>
                        <button onclick="simpanTransaksi()" class="w-full bg-blue-600 text-white py-4 rounded-md font-black shadow-lg hover:-translate-y-1 transition-all uppercase text-xs tracking-widest">üöÄ Simpan Transaksi</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
                <div class="flex flex-col md:flex-row justify-between items-center border-b pb-4 mb-4 gap-4">
                    <h3 class="font-black text-slate-700 uppercase text-xs tracking-widest">Histori Penjualan</h3>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" id="filterGeneral" onkeyup="renderTransaksi()" class="p-2 bg-slate-50 rounded-xl text-xs flex-1 border outline-none" placeholder="Cari Nama/Barang...">
                        <input type="date" id="filterTanggal" onchange="renderTransaksi()" class="p-2 bg-white rounded-xl text-[10px] border outline-none">
                    </div>
                </div>
                <div class="overflow-x-auto custom-scroll">
                    <table class="w-full text-left text-xs border-separate border-spacing-y-2">
                        <thead><tr class="text-slate-400 font-bold uppercase text-[10px] tracking-widest"><th class="px-4">Tgl</th><th class="px-4">Pelanggan</th><th class="px-4">Barang</th><th class="px-4">Total</th><th class="px-4">Sisa</th><th class="px-4 text-center">Aksi</th></tr></thead>
                        <tbody id="listTransaksi"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="piutang" class="tab-content">
        <div class="bg-white p-8 rounded-[2rem] shadow-sm border">
            <h3 class="font-black text-slate-700 uppercase text-xs tracking-widest mb-8 border-b pb-4">Kartu Piutang Aktif</h3>
            <div id="kartuPiutangContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
        </div>
    </div>
</div>

<div id="modalEditTransaksi" class="modal flex items-center justify-center p-4" style="display: none;">
    <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-md border border-slate-100">
        <h3 class="font-black text-slate-800 uppercase text-sm border-b pb-4 mb-6">‚úèÔ∏è Edit & Tambah Barang</h3>
        <input type="hidden" id="editMainTransId">
        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nama Pembeli</label>
                <input type="text" id="editMainPembeli" class="w-full p-3 border rounded-2xl bg-slate-50 text-sm outline-none" placeholder="Nama">
            </div>
            
            <div class="bg-blue-50 p-4 rounded-3xl border border-blue-100">
                <label class="text-[10px] font-black text-blue-600 uppercase mb-2 block tracking-widest">Daftar Barang</label>
                <div id="listBarangEdit" class="space-y-2 mb-3 max-h-40 overflow-y-auto custom-scroll"></div>
                <div class="flex gap-2 border-t pt-3 border-blue-200 mt-2">
                    <input type="text" id="newBarangNama" class="flex-1 p-2 text-xs border rounded-xl outline-none" placeholder="Tambah Barang">
                    <input type="number" id="newBarangHarga" class="w-24 p-2 text-xs border rounded-xl outline-none font-bold" placeholder="Harga">
                    <button onclick="tambahBarangKeDaftar()" class="bg-blue-600 text-white px-3 rounded-xl font-black">+</button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">No WhatsApp</label>
                    <input type="text" id="editMainNoHp" class="w-full p-3 border rounded-2xl bg-slate-50 text-sm outline-none" placeholder="WhatsApp">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Harga Total</label>
                    <input type="number" id="editMainHarga" class="w-full p-3 border rounded-2xl bg-slate-200 font-black text-blue-600 text-sm outline-none" readonly>
                </div>
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Alamat</label>
                <textarea id="editMainAlamat" class="w-full p-3 border rounded-2xl bg-slate-50 h-16 resize-none text-sm outline-none" placeholder="Alamat"></textarea>
            </div>
        </div>
        
        <div class="flex justify-end gap-3 mt-8 pt-4 border-t">
            <button onclick="closeModal('modalEditTransaksi')" class="px-6 py-2.5 bg-slate-100 rounded-2xl font-bold text-sm">Batal</button>
            <button onclick="updateTransaksiUtama()" class="px-6 py-2.5 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg shadow-blue-200">Simpan Perubahan</button>
        </div>
    </div>
</div>

<div id="modalEditCicilan" class="modal flex items-center justify-center p-4" style="display: none;">
    <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-sm">
        <h3 class="font-black text-emerald-800 uppercase text-sm border-b pb-4 mb-6 text-center">‚úèÔ∏è Edit Nominal Bayar</h3>
        <input type="hidden" id="editTransId"><input type="hidden" id="editCicilIdx">
        <input type="number" id="editCicilNominal" class="w-full p-5 border rounded-2xl bg-slate-50 text-2xl font-black text-center text-emerald-600 outline-none">
        <div class="flex justify-end gap-3 mt-8">
            <button onclick="closeModal('modalEditCicilan')" class="px-6 py-2.5 bg-slate-100 rounded-2xl font-bold">Batal</button>
            <button onclick="updateCicilan()" class="px-6 py-2.5 bg-emerald-600 text-white rounded-2xl font-black shadow-lg">Simpan</button>
        </div>
    </div>
</div>

<script>
// 1. LOGIN & SECURITY
const MASTER_PASSWORD = "kreditku";
function checkLogin() {
    if (document.getElementById('pass-input').value === MASTER_PASSWORD) {
        sessionStorage.setItem('kk_akses', 'aktif');
        document.getElementById('login-page').style.display = 'none';
    } else { alert("Password Salah!"); }
}
function logout() { sessionStorage.removeItem('kk_akses'); location.reload(); }
(function() { if (sessionStorage.getItem('kk_akses') === 'aktif') { if(document.getElementById('login-page')) document.getElementById('login-page').style.display = 'none'; } })();

// 2. DATABASE CONFIG
const firebaseConfig = { databaseURL: "https://bus-managemen-5fca8-default-rtdb.asia-southeast1.firebasedatabase.app/", projectId: "bus-managemen-5fca8" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dbRef = db.ref("kangkredit");
let dataTransaksi = JSON.parse(localStorage.getItem('db_penjualan_v4')) || [];

function saveToLocal() {
    localStorage.setItem('db_penjualan_v4', JSON.stringify(dataTransaksi));
    dbRef.set(dataTransaksi);
    updateCashFlow();
}

// 3. MULTI-ITEM LOGIC
function renderListBarangEdit(daftar) {
    const container = document.getElementById('listBarangEdit');
    if(!container) return;
    container.innerHTML = (daftar || []).map((b, idx) => `
        <div class="flex justify-between items-center bg-white p-2 rounded-xl border border-blue-100">
            <div class="flex flex-col">
                <span class="text-[11px] font-bold text-slate-700">${b.nama}</span>
                <span class="text-[10px] text-blue-600">Rp ${b.harga.toLocaleString('id-ID')}</span>
            </div>
            <button onclick="hapusBarangDariDaftar(${idx})" class="text-rose-500 font-black px-2 hover:bg-rose-50 rounded-lg">√ó</button>
        </div>
    `).join('');
}

function openEditTransaksi(id) {
    const t = dataTransaksi.find(item => item.id === id);
    if(!t) return;
    document.getElementById('editMainTransId').value = t.id;
    document.getElementById('editMainPembeli').value = t.pembeli || '';
    document.getElementById('editMainNoHp').value = t.no_hp || '';
    document.getElementById('editMainAlamat').value = t.alamat || '';
    document.getElementById('editMainHarga').value = t.harga || 0;
    
    if(!t.daftarBarang) t.daftarBarang = [{ nama: t.barang, harga: t.harga }];
    
    renderListBarangEdit(t.daftarBarang);
    document.getElementById('modalEditTransaksi').style.display = 'flex';
}

function tambahBarangKeDaftar() {
    const id = parseInt(document.getElementById('editMainTransId').value);
    const nama = document.getElementById('newBarangNama').value;
    const harga = parseFloat(document.getElementById('newBarangHarga').value);
    if(!nama || !harga) return alert("Isi nama & harga!");
    
    const idx = dataTransaksi.findIndex(t => t.id === id);
    if(!dataTransaksi[idx].daftarBarang) dataTransaksi[idx].daftarBarang = [{ nama: dataTransaksi[idx].barang, harga: dataTransaksi[idx].harga }];
    
    dataTransaksi[idx].daftarBarang.push({ nama, harga });
    dataTransaksi[idx].harga = dataTransaksi[idx].daftarBarang.reduce((sum, b) => sum + (parseFloat(b.harga)||0), 0);
    dataTransaksi[idx].barang = dataTransaksi[idx].daftarBarang.map(b => b.nama).join(', ');
    
    document.getElementById('editMainHarga').value = dataTransaksi[idx].harga;
    document.getElementById('newBarangNama').value = ""; 
    document.getElementById('newBarangHarga').value = "";
    renderListBarangEdit(dataTransaksi[idx].daftarBarang);
    calculateSisa(id);
}

function hapusBarangDariDaftar(barangIdx) {
    const id = parseInt(document.getElementById('editMainTransId').value);
    const transIdx = dataTransaksi.findIndex(t => t.id === id);
    if(confirm("Hapus barang dari daftar?")) {
        dataTransaksi[transIdx].daftarBarang.splice(barangIdx, 1);
        dataTransaksi[transIdx].harga = dataTransaksi[transIdx].daftarBarang.reduce((sum, b) => sum + (parseFloat(b.harga)||0), 0);
        dataTransaksi[transIdx].barang = dataTransaksi[transIdx].daftarBarang.map(b => b.nama).join(', ');
        document.getElementById('editMainHarga').value = dataTransaksi[transIdx].harga;
        renderListBarangEdit(dataTransaksi[transIdx].daftarBarang);
        calculateSisa(id);
    }
}

// 4. CORE ENGINE
function calculateSisa(id) {
    const idx = dataTransaksi.findIndex(t => t.id === id);
    if(idx===-1) return;
    const totalBayar = (dataTransaksi[idx].cicilan || []).reduce((sum, c) => sum + (parseFloat(c.jml) || 0), 0);
    dataTransaksi[idx].sisa = Math.max(0, (dataTransaksi[idx].harga || 0) - totalBayar);
    dataTransaksi[idx].status = dataTransaksi[idx].sisa <= 0 ? "Lunas" : "Kredit";
}

function simpanTransaksi() {
    const pembeli = document.getElementById('pembeli').value;
    const barang = document.getElementById('barang').value;
    const harga = parseFloat(document.getElementById('harga').value) || 0;
    const bayarAwal = parseFloat(document.getElementById('bayarAwal').value) || 0;
    const tgl = new Date();
    if(!pembeli || !barang || harga <= 0) return alert("Lengkapi data!");
    
    const baru = {
        id: Date.now(),
        tanggal: tgl.toISOString().split('T')[0],
        tglDisplay: tgl.toLocaleDateString('id-ID', {day:'2-digit',month:'2-digit',year:'numeric'}),
        pembeli, barang, harga,
        no_hp: document.getElementById('no_hp').value,
        alamat: document.getElementById('alamat').value,
        metode: document.getElementById('metode').value,
        daftarBarang: [{ nama: barang, harga: harga }],
        status: "Kredit",
        cicilan: [{ tgl: tgl.toLocaleDateString('id-ID', {day:'2-digit',month:'2-digit',year:'numeric'}), jml: bayarAwal }]
    };
    dataTransaksi.push(baru); 
    calculateSisa(baru.id); 
    saveToLocal(); 
    renderTransaksi(); 
    resetForm();
    alert("Berhasil Disimpan!");
}

function renderTransaksi() {
    const fText = document.getElementById('filterGeneral').value.toLowerCase();
    const fDate = document.getElementById('filterTanggal').value;
    const container = document.getElementById('listTransaksi');
    if(!container) return;
    
    const filtered = dataTransaksi.filter(t => {
        const mText = (t.pembeli || "").toLowerCase().includes(fText) || (t.barang || "").toLowerCase().includes(fText) || (t.alamat || "").toLowerCase().includes(fText);
        const mDate = fDate === "" || t.tanggal === fDate;
        return mText && mDate;
    });

    container.innerHTML = filtered.slice().reverse().map(t => `
        <tr class="bg-white hover:bg-slate-50 transition shadow-sm">
            <td class="px-4 py-4 font-bold text-slate-500">${t.tglDisplay}</td>
            <td class="px-4 py-4">
                <div class="font-black uppercase text-slate-800">${t.pembeli}</div>
                <div class="text-[10px] text-blue-600 font-bold">${t.no_hp || '-'}</div>
                <div class="text-[9px] text-slate-400 italic">${t.alamat || '-'}</div>
            </td>
            <td class="px-4 py-4 text-xs font-bold text-slate-600">${t.barang}</td>
            <td class="px-4 py-4 font-black">Rp ${(t.harga||0).toLocaleString()}</td>
            <td class="px-4 py-4">
                <div class="font-black ${(t.sisa||0) > 0 ? 'text-rose-600' : 'text-emerald-600'}">Rp ${(t.sisa||0).toLocaleString()}</div>
                <div class="text-[9px] font-black uppercase px-2 py-0.5 rounded-full inline-block ${t.status === 'Lunas' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}">${t.status}</div>
            </td>
            <td class="px-4 py-4 text-center">
                <button onclick="openEditTransaksi(${t.id})" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition">‚úèÔ∏è</button>
                <button onclick="hapusTransaksi(${t.id})" class="p-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-500 hover:text-white transition">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');
}

function renderPiutang() {
    const container = document.getElementById('kartuPiutangContainer');
    if(!container) return;
    const piutang = dataTransaksi.filter(t => t.metode === 'Kredit' && t.status === 'Kredit');
    if(!piutang.length) return container.innerHTML = "<p class='col-span-full text-center text-slate-400 py-10 italic'>Tidak ada piutang aktif.</p>";
    
    container.innerHTML = piutang.map(t => `
        <div class="bg-white border-t-4 border-rose-500 p-4 rounded-xl shadow-sm">
            <div class="flex justify-between items-start mb-1">
                <h4 class="font-black text-slate-800 uppercase text-sm truncate pr-2">${t.pembeli}</h4>
                <button onclick="kirimWA(${t.id})" class="hover:scale-110 transition-transform">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.3379 17L2 22L7.1553 20.7093C8.58687 21.5367 10.2404 22 12 22ZM15.9324 14.5056C15.7533 14.4172 14.8732 13.9877 14.7088 13.9288C14.5444 13.8698 14.4251 13.8404 14.3057 14.0171C14.1864 14.1938 13.843 14.5915 13.7385 14.7094C13.634 14.8272 13.5296 14.842 13.3506 14.7535C13.1715 14.6651 12.5937 14.4752 11.9096 13.8658C11.377 13.3913 11.0184 12.8055 10.914 12.6288C10.8095 12.452 10.9032 12.3564 10.9926 12.2682C11.0728 12.189 11.171 12.06 11.2605 11.9569C11.35 11.8539 11.3798 11.7802 11.4395 11.6624C11.4991 11.5446 11.4693 11.4415 11.4246 11.3531C11.3798 11.2647 11.0366 10.4252 10.8874 10.0718C10.7419 9.72756 10.595 9.77491 10.4842 9.77491C10.3793 9.77491 10.2599 9.76018 10.1406 9.76018C10.0212 9.76018 9.82725 9.80436 9.6631 9.9811C9.49896 10.1578 9.0364 10.5849 9.0364 11.4539C9.0364 12.3229 9.67803 13.1624 9.76756 13.2802C9.85709 13.398 11.0303 15.2096 12.8333 15.9872C13.2624 16.1722 13.5932 16.2813 13.854 16.3644C14.2847 16.5012 14.6766 16.4812 14.9863 16.4351C15.3316 16.3835 16.0504 15.9984 16.2 15.5713C16.1496 15.1441 16.1496 14.776 16.1048 14.7024C16.0599 14.6288 15.9406 14.5994 15.9324 14.5056Z" fill="#25D366"/>
                    </svg>
                </button>
            </div>
            <p class="text-[10px] text-slate-400 font-bold uppercase truncate mb-3">${t.barang}</p>
            <div class="bg-slate-50 p-2 rounded-xl mb-3">
                <p class="text-[9px] font-black text-slate-400 uppercase">Sisa Piutang</p>
                <div class="text-base font-black text-rose-600">Rp ${(t.sisa||0).toLocaleString('id-ID')}</div>
            </div>
            <div class="flex gap-1.5 mb-3">
                <input type="number" id="in-${t.id}" class="w-full p-2 bg-slate-50 border rounded-lg text-xs outline-none focus:border-emerald-500 font-bold" placeholder="Bayar Rp">
                <button onclick="tambahCicilan(${t.id})" class="bg-emerald-500 text-white px-3 py-2 rounded-lg font-black text-[10px] hover:bg-emerald-600">PAY</button>
            </div>
            <details class="text-[9px]">
                <summary class="font-bold text-slate-400 uppercase cursor-pointer py-1 bg-slate-50 rounded text-center list-none">Riwayat Bayar ‚ñº</summary>
                <div class="mt-2 space-y-1 max-h-24 overflow-y-auto custom-scroll">
                    ${(t.cicilan || []).map((c, i) => `
                        <div class="flex justify-between border-b border-slate-50 py-1">
                            <span>${c.tgl}</span>
                            <span class="font-bold">Rp ${(c.jml||0).toLocaleString()}</span>
                            <div class="flex gap-1">
                                <button onclick="openEditCicilan(${t.id}, ${i})" class="text-blue-400">‚úèÔ∏è</button>
                                <button onclick="hapusCicilan(${t.id}, ${i})" class="text-rose-400">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </details>
        </div>
    `).join('');
}

// 5. HELPER FUNCTIONS
function tambahCicilan(id) {
    const input = document.getElementById(`in-${id}`);
    const jml = parseFloat(input.value);
    if(!jml || jml <= 0) return alert("Nominal tidak valid!");
    const idx = dataTransaksi.findIndex(t => t.id === id);
    if(idx===-1) return;
    if(!dataTransaksi[idx].cicilan) dataTransaksi[idx].cicilan = [];
    dataTransaksi[idx].cicilan.push({ tgl: new Date().toLocaleDateString('id-ID', {day:'2-digit',month:'2-digit',year:'numeric'}), jml });
    calculateSisa(id); saveToLocal(); renderPiutang(); input.value = "";
}

function openEditCicilan(id, idx) {
    const t = dataTransaksi.find(x => x.id === id);
    document.getElementById('editTransId').value = id; 
    document.getElementById('editCicilIdx').value = idx;
    document.getElementById('editCicilNominal').value = t.cicilan[idx].jml;
    document.getElementById('modalEditCicilan').style.display = 'flex';
}

function updateCicilan() {
    const id = parseInt(document.getElementById('editTransId').value);
    const idx = parseInt(document.getElementById('editCicilIdx').value);
    const val = parseFloat(document.getElementById('editCicilNominal').value) || 0;
    const tIdx = dataTransaksi.findIndex(t => t.id === id);
    if(tIdx !== -1) {
        dataTransaksi[tIdx].cicilan[idx].jml = val;
        calculateSisa(id); saveToLocal(); closeModal('modalEditCicilan'); renderPiutang();
    }
}

function hapusCicilan(id, idx) {
    if(confirm("Hapus riwayat bayar?")) {
        const tIdx = dataTransaksi.findIndex(t => t.id === id);
        dataTransaksi[tIdx].cicilan.splice(idx,1);
        calculateSisa(id); saveToLocal(); renderPiutang();
    }
}

function kirimWA(id) {
    const t = dataTransaksi.find(x => x.id === id);
    if (!t) return;

    // 1. Format Nomor HP
    let no = (t.no_hp || "").replace(/[^0-9]/g, '');
    if (no.startsWith('0')) no = '62' + no.slice(1);
    if (!no) return alert("Nomor WhatsApp tidak ditemukan!");

    // 2. Susun Daftar Barang
    let daftarBarangText = "";
    if (t.daftarBarang && t.daftarBarang.length > 0) {
        t.daftarBarang.forEach((item, index) => {
            daftarBarangText += `${index + 1}. *${item.nama}* (Rp ${item.harga.toLocaleString('id-ID')})%0A`;
        });
    } else {
        daftarBarangText += `1. *${t.barang}* (Rp ${t.harga.toLocaleString('id-ID')})%0A`;
    }

    // 3. Susun Riwayat Cicilan
    let riwayatText = "";
    let totalMasuk = 0;
    if (t.cicilan && t.cicilan.length > 0) {
        t.cicilan.forEach((c) => {
            riwayatText += `   - ${c.tgl}: Rp ${c.jml.toLocaleString('id-ID')}%0A`;
            totalMasuk += (parseFloat(c.jml) || 0);
        });
    }

    // 4. Susun Pesan WhatsApp yang Menarik
    const msg = 
        `*NOTIFIKASI TAGIHAN - KANGKREDIT*%0A` +
        `--------------------------------------------%0A` +
        `Yth. Bapak/Ibu *${t.pembeli}*%0A%0A` +
        `Berikut adalah rincian transaksi Anda:%0A%0A` +
        `*üì¶ DAFTAR BARANG:*%0A` +
        `${daftarBarangText}%0A` +
        `*üìä RINCIAN PEMBAYARAN:*%0A` +
        `üí∞ Total Harga: *Rp ${t.harga.toLocaleString('id-ID')}*%0A` +
        `‚úÖ Total Dibayar: Rp ${totalMasuk.toLocaleString('id-ID')}%0A` +
        `‚ö†Ô∏è Sisa Tagihan: *Rp ${t.sisa.toLocaleString('id-ID')}*%0A%0A` +
        `*üïí RIWAYAT CICILAN:*%0A` +
        `${riwayatText}%0A` +
        `--------------------------------------------%0A` +
        `Mohon segera melakukan pembayaran sesuai jadwal. Terima kasih telah berlangganan di KangKredit! üôèüèª`;

    window.open(`https://wa.me/${no}?text=${msg}`, '_blank');
}

function exportData() {
    const blob = new Blob([JSON.stringify(dataTransaksi)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `Backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
}

function importData(e) {
    const reader = new FileReader();
    reader.onload = (x) => {
        try {
            const data = JSON.parse(x.target.result);
            if(Array.isArray(data)) { dataTransaksi = data; saveToLocal(); renderTransaksi(); updateCashFlow(); alert("Restore Berhasil!"); }
        } catch(err) { alert("File tidak valid!"); }
    };
    reader.readAsText(e.target.files[0]); e.target.value = '';
}

function updateCashFlow() {
    const tMulai = document.getElementById('cfTanggalMulai').value;
    const tSelesai = document.getElementById('cfTanggalSelesai').value;
    const fAlamat = (document.getElementById('cfFilterAlamat').value || "").toLowerCase();
    let omset = 0, cashIn = 0, piutang = 0;

    dataTransaksi.forEach(t => {
        let matchTgl = true;
        if (tMulai && tSelesai) matchTgl = t.tanggal >= tMulai && t.tanggal <= tSelesai;
        else if (tMulai) matchTgl = t.tanggal >= tMulai;
        else if (tSelesai) matchTgl = t.tanggal <= tSelesai;
        const matchAlamat = fAlamat === "" || (t.alamat && t.alamat.toLowerCase().includes(fAlamat));
        if (matchTgl && matchAlamat) {
            omset += (t.harga || 0); piutang += (t.sisa || 0);
            (t.cicilan || []).forEach(ci => cashIn += (parseFloat(ci.jml) || 0));
        }
    });
    document.getElementById('statOmset').innerText = "Rp " + omset.toLocaleString('id-ID');
    document.getElementById('statCashIn').innerText = "Rp " + cashIn.toLocaleString('id-ID');
    document.getElementById('statPiutang').innerText = "Rp " + piutang.toLocaleString('id-ID');
}

function resetCFFilter() {
    document.getElementById('cfTanggalMulai').value = ""; 
    document.getElementById('cfTanggalSelesai').value = "";
    document.getElementById('cfFilterAlamat').value = ""; 
    updateCashFlow();
}

// FUNGSI UPDATE UTAMA (SUDAH DIPERBAIKI)
function updateTransaksiUtama() {
    const id = parseInt(document.getElementById('editMainTransId').value);
    const idx = dataTransaksi.findIndex(t => t.id === id);
    if(idx !== -1) {
        dataTransaksi[idx].pembeli = document.getElementById('editMainPembeli').value;
        dataTransaksi[idx].no_hp = document.getElementById('editMainNoHp').value;
        dataTransaksi[idx].alamat = document.getElementById('editMainAlamat').value;
        
        // Harga dan Nama Barang sudah diupdate otomatis di fungsi tambahBarangKeDaftar
        calculateSisa(id); 
        saveToLocal(); 
        closeModal('modalEditTransaksi'); 
        renderTransaksi();
        if(document.getElementById('piutang').classList.contains('active')) renderPiutang();
    }
}

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'piutang') renderPiutang(); else renderTransaksi();
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function resetForm() { 
    document.querySelectorAll('#transaksi input, #transaksi textarea').forEach(i => i.value = ''); 
    updateLabelBayar(); 
}

function hapusTransaksi(id) { 
    if(confirm("Hapus permanen transaksi ini?")) { 
        dataTransaksi = dataTransaksi.filter(t => t.id!==id); 
        saveToLocal(); 
        renderTransaksi(); 
    } 
}

function updateLabelBayar() { 
    document.getElementById('containerBayar').style.display = document.getElementById('metode').value === 'Kredit' ? 'block' : 'none'; 
}

function updateStatus(is) {
    const dot = document.getElementById('dot-status'), txt = document.getElementById('text-status');
    if(!dot || !txt) return;
    dot.className = is ? "w-2 h-2 rounded-full bg-emerald-500 shadow-lg" : "w-2 h-2 rounded-full bg-rose-500";
    txt.innerText = is ? "Online" : "Offline";
}

db.ref(".info/connected").on("value", (s) => updateStatus(s.val() === true));
dbRef.on("value", (s) => { 
    if(s.val()) { 
        dataTransaksi = Object.values(s.val()); 
        renderTransaksi(); 
        updateCashFlow(); 
        if(document.getElementById('piutang').classList.contains('active')) renderPiutang(); 
    } 
});

window.onload = () => { 
    closeModal('modalEditTransaksi');
    closeModal('modalEditCicilan');
    renderTransaksi(); 
    updateCashFlow(); 
};
</script>
</body>
</html>
